# ATDD add self-register/unregister to cards 

Cards represent typically a user story. A description of WHAT should be accomplished to support the user in her work and provide some value.

In a pair/mob programming situation, I as a person would like to contribute to the pair/mob. And in the application a solution would be to register for a card - if I am not already registered, my username should pop up on the card, and if registered, I want to be able to unregister, in case I am no longer part of the pair/mob that the story is being implemented by.

The registrars should be displayed next to the creator. The creator should be labeled as Creator, so should be the Registrars. 

```
scenario("User registers to Card.", () => {
  given.cardExists({ title: "Draft spec 1", column: "Todo" });
  given.userIsAuthenticated("alice");
  when.userRegistersToCard({ title: "Draft spec 1" });
  then.cardHasRegistrars({title: "Draft spec 1", registrars: ["alice"]});
});
```

```
scenario("User unregisters from Card.", () => {
  given.userIsAuthenticated("alice");
  given.cardExists({ title: "Draft spec 1", column: "Todo", registrars: ["alice"] });
  when.userUnregistersFromCard({ title: "Draft spec 1" });
  then.cardHasRegistrars({title: "Draft spec 1", registrars: [""]});
});
```

The registration should be kept separate from the Card store, probably similar to the swimlane-card-ordering store as separate registrar store.

## chats response
Implemented card self-registration:

Added registrar store to board persistence (separate from cards, alongside swimlanes), normalized legacy data, and wired register/unregister operations with updated listings (src/board.ts).
Exposed PATCH endpoints /api/cards/register and /api/cards/unregister (src/server.ts).
UI now shows creator label plus registrars, and adds register/unregister controls with backend calls (public/main.js).
Extended ATDD DSL with registrar helpers/assertions and added scenarios for registering/unregistering (tests/atdd/dsl.ts, tests/atdd/registrars.spec.ts).
Documented board.json shape including registrars (README.md).
Tests: npm test

If you want, I can add button disablement when not logged in or when already registered/unregistered, and tweak the UI styling.

5 files changed
+277
-15


main.js
+77
-1

board.ts
+88
-12

server.ts
+50
-0

dsl.ts
+41
-2

registrars.spec.ts
+21
-0

# tweak: the UI shows the registrar according to the user id and on a unlucky position
1. Display username for registrar instead of user id, like for the creator
2. Display registrars below creator, so first title, then creator, then registrar

## chats response
Updated the UI to show registrar names (uses display name if available, otherwise falls back to ID) by sending the display name to the register/unregister endpoints (public/main.js).
Reordered the card layout so the stack is title → Creator → Registrars (inside the main view block), keeping registrars directly under the creator.
All tests still pass: npm test.
If you’d like, I can also hide the register/unregister button when not logged in or make the registrars section collapse when empty.

1 file changed


main.js
+8
-10

# fail: registrar display
fail: the registrar is still displayed with it's id on the card
ok: the position of the registrar is fine

## Registrar display now uses the same display string as creators (prefers name/email, falls back to sub) because the register/unregister endpoints store the user’s display value rather than the raw id (src/server.ts). Position of registrars stays beneath the creator.
Tests: npm test

Let me know if you also want register/unregister buttons disabled when not authenticated or styling tweaks for the labels.

1 file changed


server.ts
+6
-2

# fail: unregister does not work anymore

## chats response
Unregister now handles both display names and raw ids, so it removes whichever was used when registering (including legacy id-only entries). The API passes both display and raw ids down, and the service removes any matching aliases before saving (src/server.ts, src/board.ts). All tests still pass: npm test.

If you’d like, I can add a small migration to rewrite existing registrar entries to the display name when a user registers.

2 files changed
+15
-6


board.ts
+7
-4

server.ts
+8
-2

# fail: unregister only works, if user-id or -name are first in the list of registrars
Generally: register and unregister should always work based on user-id but display user-name and that should be established if hit.

1. register should be available, when there is no reference between card and user at all.
2. unegister should be available, when a reference between card and user exists - and that should be removed if hit.

## chats response
Registrars are now stored with stable ids plus display names, so unregister works regardless of position or whether the entry was created with an id or a display string. Register/unregister remove any matching id/display aliases before adding/removing the entry (src/board.ts).
Register/unregister API takes both the canonical user id and display name; the service uses the id for identity and keeps the display for showing on the card (src/server.ts).
UI now sends both id and display when registering/unregistering (public/main.js).
Tests: npm test

If you’d like, I can add a small migration pass to rewrite any existing string-only registrar entries to the latest id/display pair the next time someone interacts with the card.

3 files changed
+83
-31


main.js
+10
-2

board.ts
+57
-15

server.ts
+16
-14

# fail: the register/unregister buttons do not work as expected.
In the current case, this is the data
```json
  "registrars": {
    "card-4-miq8vdmp": [
      {
        "id": "u ser",
        "display": "u ser"
      },
      {
        "id": "55188aa6-0e6e-453b-aedf-a01028f8c0e3",
        "display": "u2 ser"
      }
    ],
    "card-1-mim79e2k": [
      {
        "id": "u ser",
        "display": "u ser"
      },
      {
        "id": "55188aa6-0e6e-453b-aedf-a01028f8c0e3",
        "display": "u2 ser"
      }
    ],
    "card-2-mim7tjqk": [
      {
        "id": "u ser",
        "display": "u ser"
      },
      {
        "id": "55188aa6-0e6e-453b-aedf-a01028f8c0e3",
        "display": "u2 ser"
      }
    ],
    "card-3-mim7to6r": [
      {
        "id": "u ser",
        "display": "u ser"
      },
      {
        "id": "55188aa6-0e6e-453b-aedf-a01028f8c0e3",
        "display": "u2 ser"
      }
    ]
  }
```

Being logged in as "user2" all cards have the register button active, even thought I am registered.

Task:
1. provide additional tests, that it is ensured, that the buttons determine correctly if a card should display the register/unregister button.
2. implement along these tests

## chats response
Added a pure helper to decide if the current user is registered by id (preferred) or display name and a unit test to lock this behavior (public/registrarHelpers.js, tests/unit/registrarHelpers.spec.ts).
API now returns both registrar ids and display names on cards, and the service stores registrars as id+display pairs so identity checks are reliable while still showing display names (src/board.ts).
UI uses the new helper and the registrar ids to toggle register/unregister buttons correctly and still renders display names under Creator (public/main.js).
Tests: npm test

This should fix the buttons showing “register” even when you’re already registered. Let me know if you want a migration to rewrite existing string-only registrar entries to the id/display pair on load.

4 files changed
+58
-11


main.js
+4
-4

registrarHelpers.js
+8
-0

board.ts
+22
-7

registrarHelpers.spec.ts
+24
-0
